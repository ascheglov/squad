<!--
  Yet another calculator for Squad (joinsquad.com)
  Author: Abyx
  Belongs to public domain
-->

<title>Squad distance calculator</title>
<meta charset="UTF-8">

<style>
body { margin: 0; }
nav { float: top; position: fixed; z-index: 9; background-color: #fed; }
</style>

<nav>
  <select id="map-name">
    <option value="albasrah_minimap.jpg" m-width="3200" m-height="3200">Al Basrah</option>
    <option value="Chora1_Minimap.jpg" m-width="4066" m-height="4066">Chora</option>
    <option value="Fools_Road_v1_Minimap.jpg" m-width="1733" m-height="1777">Fool's Road</option>
    <option value="gorodok_minimap.jpg" m-width="4333" m-height="4333">Gorodok</option>
    <option value="kohat_minimap.jpg" m-width="4017" m-height="4017">Kohat Toi</option>
    <option value="kokan_minimap.jpg" m-width="2500" m-height="2500">Kokan</option>
    <option value="logarvalley_minimap.jpg" m-width="1766" m-height="1766">Logar Valley</option>
    <option value="Mestia_Minimap1.jpg" m-width="3200" m-height="3200">Mestia</option>
    <option value="Narva_Minimap.jpg" m-width="2200" m-height="2200">Narva</option>
    <option value="forest_minimap.jpg" m-width="1200" m-height="1200">OP First Light</option>
    <option value="sumari_overlay.jpg" m-width="1300" m-height="1300">Sumari Bala</option>
    <option value="yehorivka_minimap.jpg" m-width="4033" m-height="4033">Yehorivka</option>
  </select>
  <span id="dbg"></span>
</nav>

<canvas id="canvas" width="680" height="580"></canvas>

<img id="map" src="fob.png" style="display:none" />
<img id="target" src="target.png" style="display:none" />
<img id="mortar" src="mortar.png" style="display:none" />


<script>
  'use strict';
  
  const kMaxRocketRange = 815;
  const kMaxMortarRange = 1250;

  function coords2kp(x, y, size) {
    x = Math.floor(x / size) % 3;
    y = Math.floor(y / size) % 3;
    return 1 + x + 3 * (2 - y);
  }

  function coords2str(x, y) {
    const letter = String.fromCharCode('A'.charCodeAt(0) + Math.floor(x / 300));
    const number = Math.floor(y / 300) + 1;
    const kp1 = coords2kp(x, y, 100);
    const kp2 = coords2kp(x, y, 100 / 3);
    return `${letter}${number}-${kp1}-${kp2}`;
  }

  function calc(x0, y0, x1, y1) {
    const dx = x1 - x0;
    const dy = y1 - y0;
    const dist = Math.round(Math.hypot(dx, dy));
    const dir = Math.round(Math.atan2(dx, -dy) * 180 / Math.PI + 360) % 360;
    return [dist, dir];
  }

  function r2mil(r) {
    if (r <= 50 || r >= kMaxMortarRange) return 0;
    //           50    100   150   200   250   300   350   400   450
    const mil = [1579, 1558, 1538, 1517, 1496, 1475, 1453, 1431, 1409, 1387, 1364, 1341, 1317, 1292, 1267, 1240, 1212, 1183, 1152, 1118, 1081, 1039, 988, 918, 800];
    const i_frac = r / 50 - 1;
    const i = Math.floor(i_frac);
    const [a, b] = mil.slice(i);
    const k = i_frac - i;
    return Math.round(a - (a - b) * k);
  }

  function r2clicks(r) {
    const dists = [30, 115, 200, 257.5, 292.5, 320, 365, 412.5, 462.5, 515, 550, 572.5, 607.5, 640, 665, 690, 720, 742.5, 760, 795, 9000];
    if (r <= 60 || r >= kMaxRocketRange) return 0;
    return dists.findIndex(function(d) { return r < d; });
  }
</script>

<script>
  'use strict';

  const kMapImages = "//nabla.ujkl.ru/squad-maps/";

  let $dbg = document.getElementById('dbg');

  let $canvas = document.getElementById('canvas');
  let g_ctx = $canvas.getContext('2d');
  let $map = document.getElementById('map');

  let $target_img = document.getElementById('target');
  let $mortar_img = document.getElementById('mortar');

  let g_map = {
    x: 0,
    y: 0,
    scale: 1,
    map2canvas: function(x, y) {
      return [(x - this.x) * this.scale, (y - this.y) * this.scale];
    },
    canvas2map: function(x, y) {
      return [x / this.scale + this.x, y / this.scale + this.y].map(Math.round);
    },
    moveBy: function(dx, dy) {
      [this.x, this.y] = [this.x + dx, this.y + dy].map(Math.round);
    },
    draw: function() {
      const o = $map_name.querySelector('option:checked');
      let [cx, cy] = [o.getAttribute('m-width'), o.getAttribute('m-height')];
      let [sx, sy] = [$map.width / cx, $map.height / cy];
      let [scx, scy] = [$canvas.width, $canvas.height];
      let [ocx, ocy] = [scx/this.scale, scy/this.scale];
      let [imgX, imgY] = [this.x * sx, this.y * sy];
      g_ctx.drawImage($map, imgX, imgY, ocx*sx, ocy*sy, 0, 0, scx, scy);
    },
    offset: function() { return [this.x, this.y]; },
    zoom: function(e, zoomOut) {
      let oldScale = this.scale;
      let delta = this.scale < 1 ? 0.1 : this.scale < 2 ? 0.2 : 0.5;
      if (zoomOut) {
        this.scale = Math.max(0.2, this.scale - delta);
      } else {
        this.scale = Math.min(4, this.scale + delta);
      }

      let [ex, ey] = event2point_screen(e);
      let k = 1/oldScale - 1/this.scale;
      this.moveBy(ex * k, ey * k);
    },
  };

  let g_mortar = {
    x: 200,
    y: 300,
    size: 21,

    moveBy: function(dx, dy) {
      [this.x, this.y] = [this.x + dx, this.y + dy].map(Math.round);
    },

    toScreen: function() {
      return g_map.map2canvas(this.x, this.y);
    },

    isMouseOver: function(ex, ey) {
      let [sx, sy] = this.toScreen();
      return inCircle(ex, ey, sx, sy, 15);
    },

    drawCircles: function() {
      let [x, y] = this.toScreen();
      g_ctx.strokeStyle = '#0f0';
      g_ctx.lineWidth = 1;
      g_ctx.beginPath();
      g_ctx.arc(x, y, kMaxRocketRange * g_map.scale, 0, 2 * Math.PI);
      g_ctx.stroke();
      g_ctx.beginPath();
      g_ctx.arc(x, y, kMaxMortarRange * g_map.scale, 0, 2 * Math.PI);
      g_ctx.stroke();
    },

    draw: function() {
      let [x, y] = this.toScreen();
      g_ctx.drawImage($mortar_img, x - this.size/2, y - this.size/2);
    },
  };

  let g_target = {
    x: 100,
    y: 200,
    size: 21,

    moveBy: function(dx, dy) {
      [this.x, this.y] = [this.x + dx, this.y + dy].map(Math.round);
    },

    toScreen: function() {
      return g_map.map2canvas(this.x, this.y);
    },

    isMouseOver: function(ex, ey) {
      let [sx, sy] = this.toScreen();
      return inCircle(ex, ey, sx, sy, 15);
    },

    draw: function(origin) {
      let [x, y] = this.toScreen();
      g_ctx.drawImage($target_img, x - this.size/2, y - this.size/2);

      g_ctx.strokeStyle = '#fff';
      g_ctx.fillStyle = '#f00';
      g_ctx.font = '18px sans-serif';

      let textX = x + this.size / 2;
      const [dist, dir] = calc(origin.x, origin.y, this.x, this.y);
      drawText(`${dir}\u00B0 ${dist}m`, textX, y, 'bottom');

      const mil = r2mil(dist);
      const ws = r2clicks(dist);
      drawText(`${mil}mil ${ws}w`, textX, y, 'top');
    }
  };
  

  $map.onload = drawAll;

  function drawLine(x0, y0, x1, y1) {
    g_ctx.beginPath();
    g_ctx.moveTo(x0, y0);
    g_ctx.lineTo(x1, y1);
    g_ctx.stroke();
  }

  function drawGrid() {
    g_ctx.strokeStyle = 'black';
    let len = Math.max($canvas.width, $canvas.height);
    let [ofsX, ofsY] = g_map.offset();
    let [gx, gy] = [Math.floor(ofsX/300)*300, Math.floor(ofsY/300)*300];
    for (;;) {
      g_ctx.lineWidth = (gx % 3 == 0) ? 3 : 1;
      let [x, y] = g_map.map2canvas(gx, gy);
      drawLine(x, 0, x, len);
      drawLine(0, y, len, y);
      gx+=100; gy+=100;
      if (x > len) break;
    }
  }

  function drawText(str, x, y, baseline) {
    g_ctx.textBaseline = baseline;
    g_ctx.lineWidth = 4;
    g_ctx.strokeText(str, x, y);
    g_ctx.fillText(str, x, y);
  }
  
  let g_frame = 0;
  function drawDbg() {
    g_frame++;
    g_ctx.strokeStyle = '#fff';
    g_ctx.fillStyle = '#000';
    g_ctx.font = '25px sans-serif';
    let text = `${g_frame} | ${g_map.x} ${g_map.y} | ${Math.round(g_map.scale*100)}%`;
    drawText(text, 0, $canvas.height, 'bottom');
  }
  
  function drawAll() {
    let [scx, scy] = [$canvas.width, $canvas.height];
    g_ctx.fillStyle='#aaa';
    g_ctx.fillRect(0, 0, scx, scy);

    g_map.draw();

    drawGrid();

    g_mortar.drawCircles();

    g_target.draw(g_mortar);

    g_mortar.draw();

    drawDbg();
  }

  function event2point_screen(e) {
    const rc = $canvas.getBoundingClientRect();
    return [e.clientX - rc.left, e.clientY - rc.top];
  }

  function event2point(e) {
    const [ex, ey] = event2point_screen(e);
    return g_map.canvas2map(ex, ey);
  }

  function inCircle(x, y, x0, y0, r) {
    return Math.hypot(x - x0, y - y0) < r;
  }

  let movingArty = false;
  let movingTgt = false;
  let movingMap = false;

  $canvas.onmousedown = function(e) {
    let [ex, ey] = event2point_screen(e);
    let [x,y] = g_map.canvas2map(ex, ey);

    movingTgt = g_target.isMouseOver(ex, ey); 
    if (movingTgt) return;

    movingArty = g_mortar.isMouseOver(ex, ey); 
    if (movingArty) return;

    movingMap = true;
  }

  function resetMove() {
    movingArty = false;
    movingTgt = false;
    movingMap = false;
  }
  $canvas.onmouseup = resetMove;
  $canvas.onmouseleave = resetMove;

  let [oldX, oldY] = [0, 0];
  $canvas.onmousemove = function(e) {
    let [x,y] = event2point(e);
    $dbg.innerText = coords2str(x, y);
    let [dx, dy] = [(e.clientX - oldX) / g_map.scale, (e.clientY - oldY) / g_map.scale];
    [oldX, oldY] = [e.clientX, e.clientY];
    if (movingTgt) {
      g_target.moveBy(dx, dy);
      drawAll();
    } if (movingArty) {
      g_mortar.moveBy(dx, dy);
      drawAll();
    } if (movingMap) {
      g_map.moveBy(-dx, -dy);
      drawAll();
    }
  }
  $canvas.onwheel = function(e) {
    let zoomOut = e.deltaY > 0;
    g_map.zoom(e, zoomOut);
    drawAll();
  }

  let $map_name = document.getElementById('map-name');
  function changeMap() {
    const name = $map_name.value;
    $map.src = kMapImages + name;
  }
  $map_name.onchange = changeMap;
  changeMap();

  function onResize() {
    $canvas.width = window.innerWidth; 
    $canvas.height = window.innerHeight;
    drawAll();
  }
  window.addEventListener('resize', onResize, false);
  onResize();
</script>
